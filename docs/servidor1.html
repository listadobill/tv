<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TV BILL - Player Universal</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.0/dist/hls.min.js"></script>
<script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
<style>
  body { margin:0; font-family:sans-serif; background:#111; color:#eee; }
  .topbar { background:#8b0f0f; padding:10px; display:flex; align-items:center; }
  .topbar .logo { font-weight:bold; font-size:18px; color:#fff; }
  .search { margin-left:20px; flex:1; }
  .search input { width:100%; padding:6px 10px; border-radius:20px; border:0; }
  .container { display:flex; height:calc(100vh - 40px); }
  .sidebar { width:280px; background:#1d1d1d; overflow-y:auto; }
  .channel { display:flex; gap:8px; align-items:center; padding:8px; border-bottom:1px solid #333; cursor:pointer; }
  .channel:hover { background:#333; }
  .channel.selected { background:#8b0f0f; }
  .thumb { width:50px; height:30px; background:#222; flex-shrink:0; display:flex; align-items:center; justify-content:center; }
  .thumb img { width:100%; height:100%; object-fit:cover; }
  .meta { flex:1; }
  .meta .title { font-size:14px; font-weight:600; }
  .meta .group { font-size:12px; color:#aaa; }
  .player { flex:1; display:flex; flex-direction:column; background:#000; position:relative; }
  video,audio { width:100%; height:100%; background:#000; }
  .attempt { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; text-align:center; }
  .spinner { width:40px; height:40px; border:5px solid rgba(255,255,255,0.2); border-top:5px solid red; border-radius:50%; margin:0 auto 10px; animation:spin 1s linear infinite; }
  @keyframes spin { to{ transform:rotate(360deg);} }
</style>
</head>
<body>
<div class="topbar">
  <div class="logo">ðŸ“º TV BILL</div>
  <div class="search"><input id="search" placeholder="Buscar canal..." /></div>
</div>
<div class="container">
  <div class="sidebar" id="channels"></div>
  <div class="player">
    <video id="video" controls playsinline></video>
    <audio id="audio" controls playsinline style="display:none"></audio>
    <div class="attempt" id="attemptBox" style="display:none">
      <div class="spinner"></div>
      <div id="attemptText">Reconectando...</div>
    </div>
  </div>
</div>

<script>
const listaURL = "https://raw.githubusercontent.com/listadobill/tv/refs/heads/main/servidor1.m3u";
const channelsEl = document.getElementById("channels");
const searchEl = document.getElementById("search");
const video = document.getElementById("video");
const audio = document.getElementById("audio");
const attemptBox = document.getElementById("attemptBox");
const attemptText = document.getElementById("attemptText");

let channels = [];
let current = null;
let hls = null;
let dash = null;
let reconnecting = false;
let attempt = 0;
let timer = null;

// carregar lista M3U
async function loadList() {
  const res = await fetch(listaURL);
  const text = await res.text();
  parseM3U(text);
  renderList();
}

function parseM3U(text) {
  const lines = text.split("\n");
  let currentInfo = {};
  channels = [];
  for (let line of lines) {
    line = line.trim();
    if (line.startsWith("#EXTINF")) {
      const logoMatch = line.match(/tvg-logo="([^"]+)"/);
      const groupMatch = line.match(/group-title="([^"]+)"/);
      const name = line.split(",").pop().trim();
      currentInfo = {
        title: name,
        group: groupMatch ? groupMatch[1] : "",
        logo: logoMatch ? logoMatch[1] : "",
      };
    } else if (line && !line.startsWith("#")) {
      currentInfo.url = line;
      channels.push(currentInfo);
      currentInfo = {};
    }
  }
}

function renderList(filter="") {
  channelsEl.innerHTML = "";
  const f = filter.toLowerCase();
  channels.filter(c => c.title.toLowerCase().includes(f)).forEach((c,i) => {
    const div = document.createElement("div");
    div.className = "channel";
    div.dataset.index = i;
    div.innerHTML = `
      <div class="thumb">${c.logo ? `<img src="${c.logo}" onerror="this.remove()">`:"TV"}</div>
      <div class="meta">
        <div class="title">${c.title}</div>
        <div class="group">${c.group}</div>
      </div>`;
    div.onclick = () => selectChannel(i, div);
    channelsEl.appendChild(div);
  });
}

function selectChannel(i, el) {
  document.querySelectorAll(".channel").forEach(c => c.classList.remove("selected"));
  el.classList.add("selected");
  current = channels[i];
  attempt = 0;
  stopReconnect();
  playChannel(current.url);
  requestFullscreenSafe(video.parentNode);
}

function playChannel(url) {
  cleanup();
  const ext = url.split("?")[0].split(".").pop().toLowerCase();
  showAttempt("Conectando...");

  if (["mp3","aac"].includes(ext)) {
    video.style.display="none";
    audio.style.display="block";
    audio.src = url;
    tryPlay(audio);
    audio.onended = startReconnect;
    audio.onerror = startReconnect;
    audio.onstalled = startReconnect;
    audio.onplaying = hideAttempt;
  }
  else {
    video.style.display="block";
    audio.style.display="none";

    if (ext === "m3u8") {
      hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, ()=>tryPlay(video));
      hls.on(Hls.Events.ERROR, (evt,data)=>{ if(data.fatal) startReconnect(); });
    }
    else if (ext === "mpd") {
      dash = dashjs.MediaPlayer().create();
      dash.initialize(video, url, true);
      video.onplaying = hideAttempt;
      video.onerror = startReconnect;
    }
    else {
      video.src = url;
      tryPlay(video);
    }

    video.onended = startReconnect;
    video.onerror = startReconnect;
    video.onstalled = startReconnect;
  }
}

function tryPlay(el) {
  el.play().then(hideAttempt).catch(startReconnect);
}

function cleanup() {
  if (hls) { hls.destroy(); hls=null; }
  if (dash) { dash.reset(); dash=null; }
  video.pause(); video.removeAttribute("src"); video.load();
  audio.pause(); audio.removeAttribute("src"); audio.load();
}

function startReconnect() {
  if (!current) return;
  if (reconnecting) return;
  reconnecting = true;
  scheduleReconnect();
}

function scheduleReconnect() {
  if (!current) return;
  attempt++;
  const delay = Math.min(60000, Math.pow(2, Math.min(attempt,10)) * 1000);
  showAttempt(`Tentativa ${attempt} em ${delay/1000}s...`);
  timer = setTimeout(() => {
    reconnecting = false;
    playChannel(current.url);
  }, delay);
}

function stopReconnect() {
  reconnecting = false;
  if (timer) clearTimeout(timer);
  hideAttempt();
}

function showAttempt(msg) {
  attemptBox.style.display = "block";
  attemptText.textContent = msg;
}
function hideAttempt() {
  attemptBox.style.display = "none";
}

function requestFullscreenSafe(el) {
  const req = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
  if (req) req.call(el).catch(()=>{});
}

searchEl.oninput = e => renderList(e.target.value);

loadList();
</script>
</body>
</html>
