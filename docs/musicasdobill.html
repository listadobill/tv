<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Caverna do Rock Player</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#000; color:#fff; display:flex; flex-direction:column; height:100vh; overflow:hidden;}
.header { padding:10px 15px; background:#111; display:flex; justify-content:space-between; align-items:center;}
.header h1 { font-size:1.5rem; }
.search-box input { padding:5px 10px; border-radius:5px; border:none; width:200px;}
.main { flex:1; display:flex; }
.sidebar { width:30%; background:#222; padding:10px; overflow-y:auto; }
.format-filters button { padding:5px 10px; margin:2px; cursor:pointer; }
.format-filters button.active { background:#0f0; color:#000; }
.results .result-item { padding:5px; cursor:pointer; border-bottom:1px solid #333; }
.results .result-item.playing { background:#f06; color:#000; }
.player { flex:1; padding:10px; display:flex; flex-direction:column; align-items:center; overflow-y:auto; position:relative; }
.cover-art { max-width:250px; display:none; margin-bottom:10px; }
.player-controls button { margin:2px; padding:5px 10px; cursor:pointer; }
#volumeControl { width:100px; }
#track-info { margin-top:10px; font-weight:bold; text-align:center; }
#startIcon { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:5rem; cursor:pointer; color:#0f0; z-index:1000; }
</style>
</head>
<body>

<div class="header">
  <h1>Caverna do Rock</h1>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Buscar artista, √°lbum ou m√∫sica...">
  </div>
</div>

<div class="main">
  <div class="sidebar">
    <div class="format-filters" id="formatFilters"></div>
    <div class="results" id="results">Carregando...</div>
  </div>
  <div class="player">
    <div id="startIcon">‚ñ∂</div>
    <img id="cover-art" class="cover-art">
    <div class="player-controls">
      <button onclick="prevTrack()">‚èÆ</button>
      <button onclick="togglePlayPause()" id="playPauseBtn">‚ñ∂</button>
      <button onclick="stopTrack()">‚èπ</button>
      <button onclick="nextTrack()">‚è≠</button>
      <button onclick="toggleShuffle()">üîÄ</button>
      <button onclick="toggleRepeat()">üîÅ</button>
      <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.5">
    </div>
    <audio id="audio-player" controls></audio>
    <div id="track-info"></div>
  </div>
</div>

<script>
var ALLOWED_EXT=['mp3','wav','ogg','flac','mp4'];
var tracks=[], allTracks=[], currentTrack=0, currentFormat='mp3';
var shuffle=true, repeat=false;

var audioPlayer=document.getElementById('audio-player');
var resultsContainer=document.getElementById('results');
var trackInfo=document.getElementById('track-info');
var coverArt=document.getElementById('cover-art');
var playPauseBtn=document.getElementById('playPauseBtn');
var volumeControl=document.getElementById('volumeControl');
var formatFilters=document.getElementById('formatFilters');
var searchInput=document.getElementById('searchInput');
var startIcon=document.getElementById('startIcon');

var albumLinks=["https://archive.org/details/master-of-puppets_202509"];
var albums=[];
for(var i=0;i<albumLinks.length;i++){
  var id=albumLinks[i].split('/').pop();
  var title=id.replace(/[_-]/g,' ').replace(/\b\w/g,function(l){return l.toUpperCase();});
  albums.push({title:title,id:id});
}

function carregarAlbuns(){
  resultsContainer.innerHTML='';
  allTracks=[];
  var remaining=albums.length;
  for(var i=0;i<albums.length;i++){
    (function(album){
      var xhr=new XMLHttpRequest();
      xhr.open('GET','https://archive.org/metadata/'+album.id,true);
      xhr.onreadystatechange=function(){
        if(xhr.readyState===4 && xhr.status===200){
          var data=JSON.parse(xhr.responseText);
          if(data.misc && data.misc.image && !coverArt.src){ coverArt.src=data.misc.image; coverArt.style.display='block'; }
          for(var j=0;j<data.files.length;j++){
            var f=data.files[j];
            var ext=f.name.split('.').pop().toLowerCase();
            if(ALLOWED_EXT.indexOf(ext)>=0){
              allTracks.push({
                title:f.name,
                url:'https://archive.org/download/'+album.id+'/'+encodeURIComponent(f.name),
                type:ext==='mp4'?'video':'audio',
                artist:data.metadata&&data.metadata.creator?data.metadata.creator:'Desconhecido',
                album:data.metadata&&data.metadata.title?data.metadata.title:album.title,
                format:ext
              });
            }
          }
          remaining--;
          if(remaining===0){
            criarFiltros();
            renderTracks();
          }
        }
      };
      xhr.send();
    })(albums[i]);
  }
}

function criarFiltros(){
  var formats={};
  for(var i=0;i<allTracks.length;i++){ formats[allTracks[i].format]=true; }
  formatFilters.innerHTML='';
  for(var fmt in formats){
    (function(fmt){
      var btn=document.createElement('button');
      btn.textContent=fmt.toUpperCase();
      btn.className=(fmt==='mp3')?'active':'';
      btn.onclick=function(){
        currentFormat=fmt;
        var btns=formatFilters.getElementsByTagName('button');
        for(var b=0;b<btns.length;b++){ btns[b].className=''; }
        this.className='active';
        renderTracks();
        playRandomTrack();
      };
      formatFilters.appendChild(btn);
    })(fmt);
  }
}

function renderTracks(){
  resultsContainer.innerHTML='';
  tracks=[];
  for(var i=0;i<allTracks.length;i++){
    if(allTracks[i].format===currentFormat){
      (function(track){
        var div=document.createElement('div');
        div.className='result-item';
        div.textContent=track.title;
        div.onclick=function(){ playTrack(tracks.indexOf(track)); };
        track.element=div;
        tracks.push(track);
        resultsContainer.appendChild(div);
      })(allTracks[i]);
    }
  }
}

function playTrack(index){
  var track=tracks[index]; if(!track) return;
  currentTrack=index;
  for(var i=0;i<tracks.length;i++){ tracks[i].element.className='result-item'; }
  track.element.className='result-item playing';
  trackInfo.textContent=track.artist+' - '+track.title;
  playPauseBtn.textContent='‚è∏';
  audioPlayer.pause(); audioPlayer.src='';
  audioPlayer.src=track.url;
  audioPlayer.play().catch(function(){});
}

function playRandomTrack(){
  if(tracks.length===0) return;
  var r=Math.floor(Math.random()*tracks.length);
  playTrack(r);
}

function nextTrack(){ 
  if(shuffle){ playRandomTrack(); } 
  else { 
    currentTrack=(currentTrack+1)%tracks.length; 
    playTrack(currentTrack); 
  }
}

function prevTrack(){ 
  if(currentTrack>0){ playTrack(currentTrack-1); } 
}

function stopTrack(){ 
  audioPlayer.pause(); audioPlayer.currentTime=0; 
  playPauseBtn.textContent='‚ñ∂'; 
}

function togglePlayPause(){ 
  if(audioPlayer.paused){audioPlayer.play(); playPauseBtn.textContent='‚è∏';} 
  else {audioPlayer.pause(); playPauseBtn.textContent='‚ñ∂';} 
}

function toggleShuffle(){ shuffle=!shuffle; }
function toggleRepeat(){ repeat=!repeat; }

volumeControl.addEventListener('input',function(){ audioPlayer.volume=volumeControl.value; });
audioPlayer.addEventListener('ended',function(){ if(repeat){ playTrack(currentTrack); } else { nextTrack(); } });
searchInput.addEventListener('input',function(){
  var term=searchInput.value.toLowerCase();
  for(var i=0;i<tracks.length;i++){
    tracks[i].element.style.display=(tracks[i].title.toLowerCase().indexOf(term)>=0||tracks[i].artist.toLowerCase().indexOf(term)>=0)?'block':'none';
  }
});

// Evento do √≠cone inicial
startIcon.addEventListener('click', function(){
  startIcon.style.display='none';
  playRandomTrack();
});

carregarAlbuns();
</script>
</body>
</html>
