<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TV DO BILL - Sistema Avançado de Reconexão</title>
<link href="https://vjs.zencdn.net/7.20.2/video-js.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin:0; 
        padding:0; 
        background:#111; 
        color:#fff; 
        display:flex; 
        flex-direction:column; 
        height:100vh; 
        overflow:hidden; 
    }
    #container { 
        display:flex; 
        flex-direction:column; 
        width:100%; 
        height:100%; 
    }
    #main { 
        display:flex; 
        flex:1; 
        overflow:hidden; 
    }
    #player { 
        flex:2; 
        background:rgba(0,0,0,0.9); 
        position:relative; 
        display:flex; 
        justify-content:center; 
        align-items:center; 
        overflow:hidden; 
    }
    .video-js { 
        width:100% !important; 
        height:100% !important; 
        background:#000; 
    }
    #sidebar { 
        flex:1; 
        background:rgba(34,34,34,0.95); 
        overflow-y:auto; 
        padding:10px; 
        border-left:2px solid #ffcc00; 
        max-width: 350px;
    }
    #sidebar ul { 
        list-style:none; 
        padding:0; 
        margin:0; 
        display:flex; 
        flex-direction:column; 
        gap:10px; 
    }
    #sidebar li { 
        background:rgba(50,50,50,0.8); 
        border-radius:8px; 
        padding:12px 15px;
        cursor:pointer; 
        transition:all 0.3s; 
        display: flex;
        align-items: center;
        gap: 10px;
    }
    #sidebar li:hover, #sidebar li:focus, #sidebar li.active { 
        background:#ffcc00; 
        color:#000; 
        outline:none; 
        transform: translateX(5px);
    }
    #sidebar li .channel-icon {
        font-size: 18px;
    }
    #search-bar { 
        padding:15px 10px; 
        text-align:center; 
        background: rgba(40,40,40,0.9);
        border-radius: 8px;
        margin-bottom: 15px;
    }
    #search-input { 
        width:95%; 
        padding:12px 15px; 
        border:none; 
        border-radius:5px; 
        font-size:1em; 
        background: #222;
        color: white;
        border: 1px solid #444;
    }
    #search-input:focus {
        outline: 2px solid #ffcc00;
    }
    .vjs-error-display { 
        display:none !important; 
    }
    ::-webkit-scrollbar { 
        width:12px; 
    }
    ::-webkit-scrollbar-thumb { 
        background:#ffcc00; 
        border-radius:10px; 
    }
    
    /* Sistema de notificação de erros */
    #error-system {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 350px;
    }
    
    .error-notification {
        background: rgba(200, 0, 0, 0.9);
        color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideIn 0.3s ease-out;
        transform-origin: top right;
    }
    
    .error-notification.warning {
        background: rgba(220, 150, 0, 0.9);
    }
    
    .error-notification.info {
        background: rgba(0, 100, 200, 0.9);
    }
    
    .error-notification .error-icon {
        font-size: 24px;
        flex-shrink: 0;
    }
    
    .error-notification .error-content {
        flex: 1;
    }
    
    .error-notification .error-title {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 16px;
    }
    
    .error-notification .error-message {
        font-size: 14px;
        opacity: 0.9;
    }
    
    .error-notification .error-close {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 18px;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        flex-shrink: 0;
    }
    
    .error-notification .error-close:hover {
        background: rgba(255,255,255,0.2);
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    #error-display {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        z-index: 999;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 30px;
        text-align: center;
    }
    
    #error-display.visible {
        display: flex;
    }
    
    #error-display .error-icon {
        font-size: 60px;
        color: #ff3333;
        margin-bottom: 20px;
    }
    
    #error-display h2 {
        color: #ff3333;
        margin: 0 0 15px 0;
        font-size: 28px;
    }
    
    #error-display p {
        font-size: 18px;
        max-width: 600px;
        line-height: 1.5;
        margin-bottom: 25px;
    }
    
    #error-display .error-actions {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    #error-display button {
        padding: 12px 25px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    #error-display button.primary {
        background: #ffcc00;
        color: #000;
        font-weight: bold;
    }
    
    #error-display button.secondary {
        background: rgba(255,255,255,0.2);
        color: white;
    }
    
    #error-display button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    #loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: 998;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    #loading-overlay.visible {
        display: flex;
    }
    
    .spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: #ffcc00;
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    #player-stats {
        position: absolute;
        bottom: 15px;
        left: 15px;
        background: rgba(0,0,0,0.7);
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 12px;
        z-index: 997;
        display: flex;
        gap: 15px;
    }
    
    #player-stats div {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .stats-icon {
        color: #ffcc00;
    }
    
    #quality-selector {
        position: absolute;
        bottom: 15px;
        right: 15px;
        background: rgba(0,0,0,0.7);
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 12px;
        z-index: 997;
        display: none;
    }
    
    #quality-selector select {
        background: #333;
        color: white;
        border: 1px solid #555;
        border-radius: 3px;
        padding: 3px 5px;
    }
    
    @media (max-width: 1200px) {
        #main {
            flex-direction: column;
        }
        
        #sidebar {
            max-width: none;
            border-left: none;
            border-top: 2px solid #ffcc00;
            max-height: 30vh;
        }
    }
</style>
</head>
<body>
<div id="container">
    <div id="main">
        <div id="sidebar">
            <div id="search-bar">
                <input type="text" id="search-input" placeholder="Buscar canal...">
            </div>
            <ul id="lista-canais"></ul>
        </div>
        <div id="player">
            <video id="video-player" class="video-js vjs-default-skin" controls playsinline></video>
            
            <div id="error-display">
                <i class="fas fa-exclamation-circle error-icon"></i>
                <h2 id="error-title">Erro ao Carregar Conteúdo</h2>
                <p id="error-message">Não foi possível carregar o conteúdo solicitado. Por favor, tente novamente.</p>
                <div class="error-actions">
                    <button id="retry-button" class="primary"><i class="fas fa-redo"></i> Tentar Novamente</button>
                    <button id="change-channel-button" class="secondary"><i class="fas fa-list"></i> Escolher Outro Canal</button>
                </div>
            </div>
            
            <div id="loading-overlay">
                <div class="spinner"></div>
                <p id="loading-message">Carregando transmissão...</p>
            </div>
            
            <div id="player-stats">
                <div><i class="fas fa-wifi stats-icon"></i> <span id="connection-status">Conectando...</span></div>
                <div><i class="fas fa-clock stats-icon"></i> <span id="reconnect-attempts">Tentativas: 0</span></div>
                <div><i class="fas fa-broadcast-tower stats-icon"></i> <span id="buffer-health">Buffer: 0s</span></div>
            </div>
            
            <div id="quality-selector">
                <label for="quality-select">Qualidade: </label>
                <select id="quality-select">
                    <option value="auto">Auto</option>
                    <option value="high">Alta</option>
                    <option value="medium">Média</option>
                    <option value="low">Baixa</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Sistema de notificação de erros -->
<div id="error-system"></div>

<script src="https://vjs.zencdn.net/7.20.2/video.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const listaURL = "https://raw.githubusercontent.com/listadobill/tv/refs/heads/main/zteste.m3u";
    const listaCanaisElemento = document.getElementById("lista-canais");
    const searchInput = document.getElementById("search-input");
    const errorDisplay = document.getElementById("error-display");
    const errorTitle = document.getElementById("error-title");
    const errorMessage = document.getElementById("error-message");
    const retryButton = document.getElementById("retry-button");
    const changeChannelButton = document.getElementById("change-channel-button");
    const loadingOverlay = document.getElementById("loading-overlay");
    const loadingMessage = document.getElementById("loading-message");
    const connectionStatus = document.getElementById("connection-status");
    const reconnectAttempts = document.getElementById("reconnect-attempts");
    const bufferHealth = document.getElementById("buffer-health");
    const errorSystem = document.getElementById('error-system');
    const qualitySelector = document.getElementById('quality-selector');
    const qualitySelect = document.getElementById('quality-select');

    let canais = [];
    let currentChannel = null;
    let reconnectCount = 0;
    let errorTimeout = null;
    let connectionCheckInterval = null;
    let bufferCheckInterval = null;
    let isOnline = true;
    let retryDelay = 3000; // 3 segundos conforme solicitado
    let lastBufferLength = 0;
    let bufferStallCount = 0;

    const video = videojs('video-player', {
        controls: true,
        autoplay: false,
        preload: 'auto',
        fluid: true,
        responsive: true,
        html5: {
            vhs: {
                overrideNative: true,
                enableLowInitialPlaylist: true,
                smoothQualityChange: true,
                useDevicePixelRatio: true
            }
        }
    });

    // Iniciar verificação de conexão
    startConnectionMonitoring();
    
    // Iniciar monitoramento de buffer
    startBufferMonitoring();

    // Função para mostrar notificação de erro
    function showErrorNotification(title, message, type = 'error') {
        const notification = document.createElement('div');
        notification.className = `error-notification ${type}`;
        notification.innerHTML = `
            <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'} error-icon"></i>
            <div class="error-content">
                <div class="error-title">${title}</div>
                <div class="error-message">${message}</div>
            </div>
            <button class="error-close"><i class="fas fa-times"></i></button>
        `;
        
        errorSystem.appendChild(notification);
        
        // Fechar notificação ao clicar no botão
        notification.querySelector('.error-close').addEventListener('click', function() {
            notification.style.animation = 'slideIn 0.3s ease-out reverse';
            setTimeout(() => notification.remove(), 300);
        });
        
        // Remover automaticamente após 7 segundos
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }
        }, 7000);
    }

    // Função para mostrar tela de erro
    function showError(title, message) {
        errorTitle.textContent = title;
        errorMessage.textContent = message;
        errorDisplay.classList.add('visible');
    }

    // Função para ocultar tela de erro
    function hideError() {
        errorDisplay.classList.remove('visible');
    }

    // Função para mostrar loading
    function showLoading(message = 'Carregando transmissão...') {
        loadingMessage.textContent = message;
        loadingOverlay.classList.add('visible');
    }

    // Função para ocultar loading
    function hideLoading() {
        loadingOverlay.classList.remove('visible');
    }

    // Atualizar status da conexão
    function updateConnectionStatus(status, isConnected = false) {
        connectionStatus.textContent = status;
        connectionStatus.style.color = isConnected ? '#4caf50' : '#ffcc00';
    }

    // Atualizar contador de tentativas
    function updateReconnectAttempts(attempts) {
        reconnectAttempts.textContent = `Tentativas: ${attempts}`;
    }

    // Atualizar saúde do buffer
    function updateBufferHealth(length) {
        bufferHealth.textContent = `Buffer: ${length.toFixed(1)}s`;
        
        // Cor indicativa baseada no tamanho do buffer
        if (length > 10) {
            bufferHealth.style.color = '#4caf50'; // Verde - bom
        } else if (length > 5) {
            bufferHealth.style.color = '#ffcc00'; // Amarelo - médio
        } else {
            bufferHealth.style.color = '#f44336'; // Vermelho - crítico
        }
    }

    // Configurar eventos de botão
    retryButton.addEventListener('click', function() {
        hideError();
        if (currentChannel) {
            loadChannel(currentChannel);
        }
    });

    changeChannelButton.addEventListener('click', function() {
        hideError();
        // Dá foco na lista de canais para navegação por teclado
        const firstChannel = listaCanaisElemento.querySelector('li');
        if (firstChannel) firstChannel.focus();
    });

    // Monitorar conexão com a internet
    function startConnectionMonitoring() {
        // Verificar online/offline
        window.addEventListener('online', function() {
            isOnline = true;
            updateConnectionStatus('Conectado', true);
            showErrorNotification('Conexão restaurada', 'Sua conexão com a internet foi restabelecida.', 'info');
            
            // Se estávamos tentando reconectar, força uma nova tentativa
            if (currentChannel && !video.playing()) {
                showErrorNotification('Reconectando', 'Tentando reconectar ao canal...', 'info');
                setTimeout(() => loadChannel(currentChannel), 1000);
            }
        });

        window.addEventListener('offline', function() {
            isOnline = false;
            updateConnectionStatus('Sem conexão', false);
            showErrorNotification('Sem conexão', 'Sua conexão com a internet foi perdida.', 'error');
        });

        // Verificar periodicamente a conexão
        connectionCheckInterval = setInterval(checkConnection, 5000);
    }

    // Verificar status da conexão
    function checkConnection() {
        // Simples verificação de conexão
        fetch('https://httpbin.org/get?t=' + new Date().getTime(), {
            method: 'HEAD',
            cache: 'no-cache'
        })
        .then(() => {
            if (!isOnline) {
                isOnline = true;
                updateConnectionStatus('Conectado', true);
            }
        })
        .catch(() => {
            if (isOnline) {
                isOnline = false;
                updateConnectionStatus('Sem conexão', false);
            }
        });
    }

    // Monitorar saúde do buffer
    function startBufferMonitoring() {
        bufferCheckInterval = setInterval(() => {
            if (video && video.tech_ && video.tech_.vhs) {
                try {
                    const bufferEnd = video.buffered().length > 0 ? video.buffered().end(0) : 0;
                    const currentTime = video.currentTime();
                    const length = bufferEnd - currentTime;
                    
                    updateBufferHealth(length);
                    
                    // Detectar stalls no buffer
                    if (length === lastBufferLength && length < 2 && video.playing()) {
                        bufferStallCount++;
                        
                        if (bufferStallCount > 3) {
                            showErrorNotification('Problema de buffer', 'Tentando melhorar a qualidade de transmissão...', 'warning');
                            adjustQualityBasedOnBuffer();
                            bufferStallCount = 0;
                        }
                    } else {
                        bufferStallCount = 0;
                    }
                    
                    lastBufferLength = length;
                } catch (e) {
                    console.warn('Erro ao verificar buffer:', e);
                }
            }
        }, 1000);
    }

    // Ajustar qualidade baseado no buffer
    function adjustQualityBasedOnBuffer() {
        if (video && video.tech_ && video.tech_.vhs) {
            try {
                const bufferEnd = video.buffered().length > 0 ? video.buffered().end(0) : 0;
                const currentTime = video.currentTime();
                const length = bufferEnd - currentTime;
                
                if (length < 2) {
                    // Buffer baixo, reduzir qualidade se possível
                    const currentQuality = qualitySelect.value;
                    if (currentQuality === 'high') {
                        qualitySelect.value = 'medium';
                        showErrorNotification('Qualidade reduzida', 'Mudando para qualidade média para melhor fluidez', 'info');
                    } else if (currentQuality === 'medium') {
                        qualitySelect.value = 'low';
                        showErrorNotification('Qualidade reduzida', 'Mudando para qualidade baixa para melhor fluidez', 'info');
                    }
                    applyQualitySetting();
                } else if (length > 15) {
                    // Buffer saudável, tentar aumentar qualidade
                    const currentQuality = qualitySelect.value;
                    if (currentQuality === 'low') {
                        qualitySelect.value = 'medium';
                        showErrorNotification('Qualidade melhorada', 'Mudando para qualidade média', 'info');
                    } else if (currentQuality === 'medium') {
                        qualitySelect.value = 'high';
                        showErrorNotification('Qualidade melhorada', 'Mudando para qualidade alta', 'info');
                    }
                    applyQualitySetting();
                }
            } catch (e) {
                console.warn('Erro ao ajustar qualidade:', e);
            }
        }
    }

    // Aplicar configuração de qualidade
    function applyQualitySetting() {
        // Em um player real, isso alteraria a resolução/bitrate
        // Esta é uma implementação simplificada
        showErrorNotification('Qualidade alterada', `Qualidade definida para: ${qualitySelect.value}`, 'info');
    }

    // Função para carregar um canal
    function loadChannel(channel) {
        if (!isOnline) {
            showError('Sem conexão', 'Você está offline. Verifique sua conexão com a internet e tente novamente.');
            return;
        }

        currentChannel = channel;
        reconnectCount++;
        updateReconnectAttempts(reconnectCount);
        
        showLoading(`Conectando a ${channel.name}...`);
        updateConnectionStatus('Conectando...');
        
        // Mostrar seletor de qualidade para streams que suportam
        qualitySelector.style.display = 'block';
        
        video.src({ type: 'application/x-mpegURL', src: channel.url });
        video.play().catch(error => {
            console.error('Erro ao reproduzir vídeo:', error);
            handleVideoError('Erro ao reproduzir o vídeo', error);
        });
    }

    // Função para tratar erros de vídeo
    function handleVideoError(context, error) {
        console.error(`${context}:`, error);
        
        // Mostrar notificação
        let errorType = 'unknown';
        let errorMessage = 'Erro desconhecido ao carregar o vídeo.';
        
        if (error && error.code) {
            switch(error.code) {
                case 1:
                    errorType = 'network';
                    errorMessage = 'Problema de conexão. Verifique sua internet.';
                    break;
                case 2:
                    errorType = 'format';
                    errorMessage = 'Formato de mídia não suportado.';
                    break;
                case 3:
                    errorType = 'decode';
                    errorMessage = 'Erro ao decodificar o vídeo.';
                    break;
                case 4:
                    errorType = 'src';
                    errorMessage = 'Fonte de vídeo não suportada.';
                    break;
                default:
                    errorType = 'unknown';
                    errorMessage = 'Erro desconhecido ao carregar o vídeo.';
            }
        }
        
        showErrorNotification('Erro de Reprodução', errorMessage, 'error');
        
        // Mostrar mensagem de tentativa de reconexão (sem limite de tentativas)
        showLoading(`Tentativa ${reconnectCount}. Reconectando em 3 segundos...`);
        
        // Tentar reconexão após delay (3 segundos conforme solicitado)
        if (errorTimeout) clearTimeout(errorTimeout);
        errorTimeout = setTimeout(() => {
            if (currentChannel) {
                loadChannel(currentChannel);
            }
        }, retryDelay);
    }

    // Configurar event listeners para o player de vídeo
    video.on('loadstart', function() {
        updateConnectionStatus('Conectando...');
        showLoading('Carregando transmissão...');
    });

    video.on('loadeddata', function() {
        updateConnectionStatus('Conectado', true);
        hideLoading();
        hideError();
        reconnectCount = 0;
        updateReconnectAttempts(reconnectCount);
        
        // Mostrar notificação de sucesso na primeira conexão
        if (reconnectCount === 0) {
            showErrorNotification('Conexão estabelecida', `Conectado a ${currentChannel.name}`, 'info');
        } else {
            showErrorNotification('Reconexão bem-sucedida', `Reconectado a ${currentChannel.name} após ${reconnectCount} tentativas`, 'info');
        }
    });

    video.on('waiting', function() {
        updateConnectionStatus('Buffering...');
        showLoading('Buffering...');
    });

    video.on('playing', function() {
        updateConnectionStatus('Conectado', true);
        hideLoading();
    });

    video.on('error', function() {
        const error = video.error();
        handleVideoError('Erro no player de vídeo', error);
    });

    video.on('ended', function() {
        showErrorNotification('Transmissão encerrada', 'A transmissão do canal foi encerrada.', 'info');
    });

    // Carregar a lista de canais
    fetch(listaURL)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
            }
            return response.text();
        })
        .then(data => {
            const linhas = data.split('\n');
            const canaisTemp = [];

            linhas.forEach((linha, index) => {
                if (linha.startsWith('#EXTINF')) {
                    const nome = linha.split(',')[1].trim();
                    const url = linhas[index + 1];
                    if (url && !url.startsWith('#') && url.trim() !== '') {
                        // Adicionar ícone baseado no tipo de canal
                        let icon = 'fas fa-tv';
                        if (nome.toLowerCase().includes('filme') || nome.toLowerCase().includes('movie')) icon = 'fas fa-film';
                        if (nome.toLowerCase().includes('esporte') || nome.toLowerCase().includes('sport')) icon = 'fas fa-basketball-ball';
                        if (nome.toLowerCase().includes('notícia') || nome.toLowerCase().includes('news')) icon = 'fas fa-newspaper';
                        if (nome.toLowerCase().includes('infantil') || nome.toLowerCase().includes('kid')) icon = 'fas fa-child';
                        
                        canaisTemp.push({ 
                            name: nome, 
                            url: url,
                            icon: icon
                        });
                    }
                }
            });

            canais = canaisTemp.sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
            renderCanais(canais);
            
            // Mostrar notificação de sucesso
            showErrorNotification('Playlist carregada', `${canais.length} canais disponíveis`, 'info');
        })
        .catch(error => {
            console.error('Erro ao cargar a lista de canais:', error);
            showErrorNotification('Erro ao carregar canais', 'Não foi possível carregar a lista de canais. Verifique sua conexão.', 'error');
            
            // Adicionar alguns canais de fallback para demonstração
            canais = [
                { name: 'Canal Exemplo 1', url: 'https://example.com/stream1.m3u8', icon: 'fas fa-tv' },
                { name: 'Canal Exemplo 2', url: 'https://example.com/stream2.m3u8', icon: 'fas fa-tv' },
                { name: 'Canal Exemplo 3', url: 'https://example.com/stream3.m3u8', icon: 'fas fa-tv' }
            ];
            renderCanais(canais);
        });

    // Função para renderizar a lista de canais
    function renderCanais(lista) {
        listaCanaisElemento.innerHTML = '';
        lista.forEach(canal => {
            const li = document.createElement('li');
            li.tabIndex = 0;
            li.innerHTML = `<i class="${canal.icon} channel-icon"></i> ${canal.name}`;
            li.addEventListener('click', function() {
                loadChannel(canal);
                // Marca canal ativo
                document.querySelectorAll('#lista-canais li').forEach(el => el.classList.remove('active'));
                li.classList.add('active');
            });
            listaCanaisElemento.appendChild(li);
        });
    }

    // Configurar busca
    searchInput.addEventListener('input', () => {
        const filtro = searchInput.value.toLowerCase();
        const filtrados = canais.filter(c => c.name.toLowerCase().includes(filtro));
        renderCanais(filtrados);
    });

    // Navegação por teclado
    listaCanaisElemento.addEventListener('keydown', e => {
        const ativo = document.activeElement;
        if (ativo.tagName.toLowerCase() === 'li') {
            if (e.key === 'ArrowDown' && ativo.nextElementSibling) {
                ativo.nextElementSibling.focus();
                ativo.nextElementSibling.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                e.preventDefault();
            }
            if (e.key === 'ArrowUp' && ativo.previousElementSibling) {
                ativo.previousElementSibling.focus();
                ativo.previousElementSibling.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                e.preventDefault();
            }
            if (e.key === 'Enter') ativo.click();
        }
    });

    // Focar no primeiro canal ao carregar
    setTimeout(() => {
        const primeiro = listaCanaisElemento.querySelector('li');
        if (primeiro) primeiro.focus();
    }, 1000);

    // Limpar intervalos quando a página for fechada
    window.addEventListener('beforeunload', function() {
        if (connectionCheckInterval) clearInterval(connectionCheckInterval);
        if (bufferCheckInterval) clearInterval(bufferCheckInterval);
        if (errorTimeout) clearTimeout(errorTimeout);
    });
});
</script>
</body>
</html>
