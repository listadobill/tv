<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TV DO BILL</title>
<link href="https://vjs.zencdn.net/7.20.2/video-js.css" rel="stylesheet">
<style>
    body { font-family: Arial,sans-serif; margin:0; padding:0; background:#000; color:#fff; display:flex; flex-direction:column; height:100vh; overflow:hidden; }
    #container { display:flex; flex-direction:column; width:100%; height:100%; }
    #main { display:flex; flex:1; overflow:hidden; }
    #player { flex:2; background:rgba(0,0,0,0.8); position:relative; display:flex; justify-content:center; align-items:center; overflow:hidden; }
    .video-js { width:100% !important; height:100% !important; background:#000; }
    #sidebar { flex:1; background:rgba(34,34,34,0.8); overflow-y:auto; padding:10px; border-left:2px solid #ffcc00; }
    #sidebar ul { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; }
    #sidebar li { background:rgba(50,50,50,0.8); border-radius:8px; padding:10px; cursor:pointer; transition:background-color 0.3s; }
    #sidebar li:hover, #sidebar li:focus, #sidebar li.active { background:#ffcc00; color:#000; outline:none; }
    #search-bar { padding:10px; text-align:center; }
    #search-input { width:95%; padding:10px; border:none; border-radius:5px; font-size:1em; }
    .vjs-error-display { display:none !important; }
    ::-webkit-scrollbar { width:16px; }
    ::-webkit-scrollbar-thumb { background:#ffcc00; border-radius:10px; }
</style>
</head>
<body>
<div id="container">
    <div id="main">
        <div id="sidebar">
            <div id="search-bar">
                <input type="text" id="search-input" placeholder="Buscar canal...">
            </div>
            <ul id="lista-canais"></ul>
        </div>
        <div id="player">
            <video id="video-player" class="video-js vjs-default-skin" controls playsinline></video>
        </div>
    </div>
</div>

<script src="https://vjs.zencdn.net/7.20.2/video.min.js"></script>
<!-- Adicionando suporte a formatos adicionais -->
<script src="https://cdn.jsdelivr.net/npm/@videojs/http-streaming@2.14.2/dist/videojs-http-streaming.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const listaURL = "https://raw.githubusercontent.com/listadobill/tv/refs/heads/main/zteste.m3u";
    const listaCanaisElemento = document.getElementById("lista-canais");
    const searchInput = document.getElementById("search-input");

    const video = videojs('video-player', {
        controls: true,
        autoplay: false,
        preload: 'auto',
        fluid: true,
        responsive: true,
        html5: {
            vhs: {
                overrideNative: true,
                enableLowInitialPlaylist: true,
                smoothQualityChange: true,
                useDevicePixelRatio: true,
                bufferBehind: 30,
                maxBufferLength: 60
            },
            nativeAudioTracks: false,
            nativeVideoTracks: false
        },
        playbackRates: [0.5, 1, 1.25, 1.5, 2],
        liveui: true
    });

    // Adicionando suporte a mais formatos
    video.ready(function() {
        // Habilita suporte para MPEG-DASH se disponível
        if (videojs.getTech('Html5').prototype.featuresNativeDash === false) {
            try {
                videojs.registerTech('Dash', videojs.getComponent('Tech'));
            } catch(e) {
                console.log('Suporte a DASH não disponível');
            }
        }
        
        // Habilita suporte para mais codecs
        if (video.tech_ && video.tech_.vhs) {
            video.tech_.vhs.options.overrideNative = true;
        }
    });

    fetch(listaURL)
        .then(r => r.text())
        .then(data => {
            const linhas = data.split('\n');
            const canais = [];

            linhas.forEach((linha, index) => {
                if (linha.startsWith('#EXTINF')) {
                    const nome = linha.split(',')[1].trim();
                    const url = linhas[index + 1];
                    canais.push({ name: nome, url: url });
                }
            });

            canais.sort((a,b) => a.name.localeCompare(b.name,'pt-BR'));

            function renderizarCanais(lista) {
                listaCanaisElemento.innerHTML = '';
                lista.forEach(canal => {
                    const li = document.createElement('li');
                    li.tabIndex = 0;
                    li.textContent = canal.name;
                    li.addEventListener('click', function() {
                        // **Aqui está a lógica original funcional para Smart TV**
                        video.src({ type:'application/x-mpegURL', src: canal.url });
                        video.play();
                        if(video.requestFullscreen) video.requestFullscreen();
                        reconectar(canal.url);
                        // Marca canal ativo
                        document.querySelectorAll('#lista-canais li').forEach(el=>el.classList.remove('active'));
                        li.classList.add('active');
                    });
                    listaCanaisElemento.appendChild(li);
                });
            }

            renderizarCanais(canais);

            searchInput.addEventListener('input', () => {
                const filtro = searchInput.value.toLowerCase();
                const filtrados = canais.filter(c => c.name.toLowerCase().includes(filtro));
                renderizarCanais(filtrados);
            });

            // Navegação por teclado
            listaCanaisElemento.addEventListener('keydown', e => {
                const ativo = document.activeElement;
                if(ativo.tagName.toLowerCase() === 'li'){
                    if(e.key === 'ArrowDown' && ativo.nextElementSibling){
                        ativo.nextElementSibling.focus();
                        ativo.nextElementSibling.scrollIntoView({behavior:'smooth', block:'nearest'});
                        e.preventDefault();
                    }
                    if(e.key === 'ArrowUp' && ativo.previousElementSibling){
                        ativo.previousElementSibling.focus();
                        ativo.previousElementSibling.scrollIntoView({behavior:'smooth', block:'nearest'});
                        e.preventDefault();
                    }
                    if(e.key === 'Enter') ativo.click();
                }
            });

            const primeiro = listaCanaisElemento.querySelector('li');
            if(primeiro) primeiro.focus();
        })
        .catch(error => {
            console.error('Erro ao carregar lista de canais:', error);
            // Fallback básico em caso de erro
            const canaisFallback = [
                { name: 'Canal Exemplo 1', url: 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8' },
                { name: 'Canal Exemplo 2', url: 'https://cph-p2p-msl.akamaized.net/hls/live/2000341/test/master.m3u8' }
            ];
            
            function renderizarCanais(lista) {
                listaCanaisElemento.innerHTML = '';
                lista.forEach(canal => {
                    const li = document.createElement('li');
                    li.tabIndex = 0;
                    li.textContent = canal.name;
                    li.addEventListener('click', function() {
                        video.src({ type:'application/x-mpegURL', src: canal.url });
                        video.play();
                        if(video.requestFullscreen) video.requestFullscreen();
                        reconectar(canal.url);
                        document.querySelectorAll('#lista-canais li').forEach(el=>el.classList.remove('active'));
                        li.classList.add('active');
                    });
                    listaCanaisElemento.appendChild(li);
                });
            }
            
            renderizarCanais(canaisFallback);
        });

    function reconectar(url){
        video.src({ type:'application/x-mpegURL', src: url });
        video.play();
        video.off('error');
        video.on('error', function() {
            setTimeout(()=>reconectar(url), 3000); // Reduzido para 3 segundos conforme solicitado
        });
    }

    // Adicionar suporte a mais formatos de forma transparente
    const originalSrc = video.src;
    video.src = function(source) {
        if (source && source.src) {
            // Suporte para formatos adicionais
            const url = source.src.toLowerCase();
            
            // Verifica e ajusta o type automaticamente para melhor compatibilidade
            if (!source.type) {
                if (url.includes('.m3u8')) {
                    source.type = 'application/x-mpegURL';
                } else if (url.includes('.mpd')) {
                    source.type = 'application/dash+xml';
                } else if (url.includes('.mp4') || url.includes('.m4v')) {
                    source.type = 'video/mp4';
                } else if (url.includes('.webm')) {
                    source.type = 'video/webm';
                }
            }
        }
        return originalSrc.call(this, source);
    };

    // Melhor tratamento de erro para diferentes codecs
    video.on('error', function() {
        const error = video.error();
        if (error && error.code === 4) {
            // MEDIA_ERR_SRC_NOT_SUPPORTED - tenta fallback
            console.log('Formato não suportado, tentando alternativas...');
        }
    });
});
</script>
</body>
</html>
